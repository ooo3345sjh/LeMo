<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    날짜 : 2023/03/14
    이름 : 박종협
    내용 : diary mapper
 -->
<mapper namespace="kr.co.Lemo.dao.DiaryDAO">

    <!-- select -->
    <select id="selectDiaryArticle" resultType="kr.co.Lemo.domain.DiarySpotVO">
        SELECT
        	c.`user_id`, a.`arti_title`, b.*
        FROM
        	`lemo_diary_article` AS a JOIN
        	`lemo_diary_spot`    AS b ON a.`arti_no` = b.`arti_no` LEFT JOIN
        	`lemo_diary_like`    AS c ON a.`arti_no` = c.`arti_no`
    </select>

    <select id="selectDiarySpot" resultType="kr.co.Lemo.domain.DiarySpotVO">
        SELECT d.`acc_name`, e.`nick`,a.*, b.* FROM
        	`lemo_diary_article`         AS a JOIN
        	`lemo_diary_spot`            AS b ON a.`arti_no` = b.`arti_no` LEFT JOIN
        	`lemo_product_reservation`   AS c ON a.`res_no` = c.`res_no` LEFT JOIN
        	`lemo_product_accommodation` AS d ON c.`acc_id` = d.`acc_id` LEFT JOIN
        	`lemo_member_userinfo`       AS e ON a.`user_id` = e.`user_id`
        WHERE b.`arti_no` = #{arti_no};
    </select>
    
    <select id="selectDiaryComment" resultType="kr.co.Lemo.domain.DiaryCommentVO">
        SELECT
           T.`com_no`, T.`arti_no`, T.`user_id`, T.`com_pno`,
           T.`com_comment`, T.`com_regip`, T.`com_rdate`, T.`com_udate`, T.`nick`, IFNULL(F.`com_replyId`, T.`nick`) AS `com_replyId`, T.`com_state`
        FROM
           (SELECT
               `com_no`, `arti_no`, a.`user_id`, IFNULL(`com_pno`,`com_no`) AS `com_pno`,
               `com_comment`, `com_regip`, `com_rdate`, `com_udate`, b.`nick`, IFNULL(`com_replyId`, b.`user_id`) AS `com_replyId`, `com_state`
           FROM `lemo_diary_comment` AS a JOIN
               `lemo_member_userinfo` AS b ON a.`user_id` = b.`user_id`
           WHERE `arti_no`=#{arti_no})
        AS T LEFT JOIN
           (SELECT c.`com_no`, d.`nick` AS com_replyId FROM
               `lemo_diary_comment` AS c JOIN
               `lemo_member_userinfo` AS d ON d.`user_id` = c.`com_replyId`
           WHERE `arti_no`=#{arti_no})
        AS F ON T.`com_no` = F.`com_no` ORDER BY `com_rdate` ASC;
    </select>

    <select id="selectCommentNick" resultType="kr.co.Lemo.domain.UserVO">
        SELECT b.`nick`, b.`user_id` FROM `lemo_diary_comment` AS a JOIN
        `lemo_member_userinfo` AS b ON a.`user_id` = b.`user_id`
        WHERE `com_no`=#{com_no};
    </select>

    <select id="selectDiaryLike" resultType="int">
        SELECT COUNT(`user_id`) FROM `lemo_diary_like` WHERE `arti_no` = #{arti_no} AND `user_id` = #{user_id};
    </select>

    <!-- insert -->
    <insert id="insertDiaryOriComment" parameterType="kr.co.Lemo.domain.DiaryCommentVO" useGeneratedKeys="true" keyProperty="com_no">
        INSERT INTO `lemo_diary_comment` SET
            `arti_no`     = #{arti_no},
            `user_id`     = #{user_id},
            `com_comment` = #{com_comment},
            `com_regip`   = #{com_regip},
            `com_replyId` = #{com_replyId};
    </insert>

    <insert id="insertDiaryComment" parameterType="kr.co.Lemo.domain.DiaryCommentVO" useGeneratedKeys="true" keyProperty="com_no">
        INSERT INTO `lemo_diary_comment` SET
            `arti_no`     = #{arti_no},
            `user_id`     = #{user_id},
            `com_pno`     = #{com_pno},
            `com_comment` = #{com_comment},
            `com_regip`   = #{com_regip},
            `com_replyId` = #{com_replyId};
    </insert>

    <insert id="insertDiaryLike">
        INSERT `lemo_diary_like` SET
        	`arti_no` = #{arti_no},
        	`user_id` = #{user_id};
    </insert>

    <!-- update -->
    <update id="updateComment" parameterType="kr.co.Lemo.domain.DiaryCommentVO">
        UPDATE `lemo_diary_comment` SET
            `com_comment` = #{com_comment},
            `com_regip`   = #{com_regip},
            `com_udate`   = NOW()
        WHERE `com_no`=#{com_no};
    </update>

    <update id="updateOriComment" parameterType="kr.co.Lemo.domain.DiaryCommentVO">
        UPDATE `lemo_diary_comment` SET
            `com_state` = #{com_state},
            `com_regip` = #{com_regip},
            `com_udate` = NOW()
        WHERE `com_no`=#{com_no};
    </update>

    <update id="updateDiaryLikePlus">
        UPDATE `lemo_diary_article` SET `arti_like` = `arti_like`+1 WHERE `arti_no`=#{arti_no};
    </update>

    <update id="updateDiaryMinusPlus">
        UPDATE `lemo_diary_article` SET `arti_like` = `arti_like`-1 WHERE `arti_no`=#{arti_no};
    </update>

    <update id="updateDiaryHit">
        UPDATE `lemo_diary_article` SET `arti_hit` = `arti_hit`+1 WHERE `arti_no`=#{arti_no};
    </update>

    <!-- delete -->
    <delete id="deleteComment">
        DELETE FROM `lemo_diary_comment` WHERE `com_no`=#{com_no};
    </delete>

    <delete id="deleteDiaryLike">
        DELETE FROM `lemo_diary_like` WHERE `arti_no` = #{arti_no} AND `user_id` = #{user_id};
    </delete>

    <!-- 공통 키 -->

</mapper>