<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    날짜 : 2023/03/14
    이름 : 박종협
    내용 : diary mapper
 -->
<mapper namespace="kr.co.Lemo.dao.DiaryDAO">

    <!-- select -->
    <select id="selectDiaryArticle" resultType="kr.co.Lemo.domain.DiarySpotVO">
        SELECT a.`arti_title`, b.* FROM `lemo_diary_article` AS a JOIN
        `lemo_diary_spot` AS b ON a.`arti_no` = b.`arti_no`;
    </select>

    <select id="selectDiarySpot" resultType="kr.co.Lemo.domain.DiarySpotVO">
        SELECT * FROM `lemo_diary_article` AS a JOIN
        `lemo_diary_spot` AS b ON a.`arti_no` = b.`arti_no` WHERE b.`arti_no` = #{arti_no};
    </select>
    
    <select id="selectDiaryComment" resultType="kr.co.Lemo.domain.DiaryCommentVO">
        SELECT
           T.`com_no`, T.`arti_no`, T.`user_id`, T.`com_pno`,
           T.`com_comment`, T.`com_regip`, T.`com_rdate`, T.`com_udate`, T.`nick`, IFNULL(F.`com_replyId`, T.`nick`) AS `com_replyId`, T.`com_state`
        FROM
           (SELECT
               `com_no`, `arti_no`, a.`user_id`, IFNULL(`com_pno`,`com_no`) AS `com_pno`,
               `com_comment`, `com_regip`, `com_rdate`, `com_udate`, b.`nick`, IFNULL(`com_replyId`, b.`user_id`) AS `com_replyId`, `com_state`
           FROM `lemo_diary_comment` AS a JOIN
               `lemo_member_userinfo` AS b ON a.`user_id` = b.`user_id`
           WHERE `arti_no`=#{arti_no})
        AS T LEFT JOIN
           (SELECT c.`com_no`, d.`nick` AS com_replyId FROM
               `lemo_diary_comment` AS c JOIN
               `lemo_member_userinfo` AS d ON d.`user_id` = c.`com_replyId`
           WHERE `arti_no`=#{arti_no})
        AS F ON T.`com_no` = F.`com_no` ORDER BY `com_rdate` ASC;
    </select>

    <select id="selectCommentNick" resultType="kr.co.Lemo.domain.UserVO">
        SELECT b.`nick`, b.`user_id` FROM `lemo_diary_comment` AS a JOIN
        `lemo_member_userinfo` AS b ON a.`user_id` = b.`user_id`
        WHERE `com_no`=#{com_no};
    </select>

    <!--테스트용 사용중 아님 추후 삭제-->
    <resultMap id="DiarySpotVO" type="kr.co.Lemo.domain.DiarySpotVO">
        <result column="spot_no" property="spot_no"/>
        <result column="arti_no" property="arti_no"/>
        <result column="spot_longtitude" property="spot_longtitude"/>
        <result column="spot_lattitude" property="spot_lattitude"/>
        <result column="spot_title" property="spot_title"/>
        <result column="spot_content" property="spot_content"/>
        <result column="spot_thumb" property="spot_thumb"/>
        <result column="province_name" property="province_name"/>
        <result column="spot_addr" property="spot_addr"/>
    </resultMap>


    <!-- insert -->
    <insert id="insertDiaryOriComment" parameterType="kr.co.Lemo.domain.DiaryCommentVO" useGeneratedKeys="true" keyProperty="com_no">
        INSERT INTO `lemo_diary_comment` SET
            `arti_no`     = #{arti_no},
            `user_id`     = #{user_id},
            `com_comment` = #{com_comment},
            `com_regip`   = #{com_regip},
            `com_replyId` = #{com_replyId};
    </insert>

    <insert id="insertDiaryComment" parameterType="kr.co.Lemo.domain.DiaryCommentVO" useGeneratedKeys="true" keyProperty="com_no">
        INSERT INTO `lemo_diary_comment` SET
            `arti_no`     = #{arti_no},
            `user_id`     = #{user_id},
            `com_pno`     = #{com_pno},
            `com_comment` = #{com_comment},
            `com_regip`   = #{com_regip},
            `com_replyId` = #{com_replyId};
    </insert>
    <!-- update -->
    <update id="updateComment" parameterType="kr.co.Lemo.domain.DiaryCommentVO">
        UPDATE `lemo_diary_comment` SET
            `com_comment` = #{com_comment},
            `com_regip`   = #{com_regip},
            `com_udate`   = NOW()
        WHERE `com_no`=#{com_no};
    </update>

    <update id="updateOriComment" parameterType="kr.co.Lemo.domain.DiaryCommentVO">
        UPDATE `lemo_diary_comment` SET
            `com_state` = #{com_state},
            `com_regip` = #{com_regip},
            `com_udate` = NOW()
        WHERE `com_no`=#{com_no};
    </update>

    <!-- delete -->
    <delete id="deleteComment">
        DELETE FROM `lemo_diary_comment` WHERE `com_no`=#{com_no};
    </delete>

    <!-- 공통 키 -->

</mapper>