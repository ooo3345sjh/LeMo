<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    날짜 : 2023/03/09
    이름 : 박종협
    내용 : my mapper
 -->
<mapper namespace="kr.co.Lemo.dao.MyDAO">

    <!-- select -->
    <select id="selectPoints" resultType="kr.co.Lemo.domain.PointVO">
        SELECT * FROM
            `lemo_member_point_log`
        WHERE `user_id`= #{user_id} ORDER BY `poi_rdate` DESC
        LIMIT #{offset}, 10;
    </select>

    <select id="selectTotalPoints" resultType="int">
        SELECT COUNT(`poi_id`) FROM `lemo_member_point_log` WHERE `user_id`= #{user_id};
    </select>

    <select id="selectReservations" resultType="kr.co.Lemo.domain.ReservationVO">
        SELECT
            b.*, a.`acc_name`, a.`province_no`, a.`acc_thumbs`, c.`room_checkIn`, c.`room_checkOut`, b.`res_checkIn`, b.`res_checkOut`
        FROM
            `lemo_product_accommodation` AS a LEFT JOIN
            `lemo_product_reservation`   AS b ON a.`acc_id` = b.`acc_id` LEFT JOIN
            `lemo_product_room`          AS c ON b.`room_id` = c.`room_id`
        WHERE b.`user_id` = #{user_id}
        <if test="myCate == 'review'">
            AND b.`res_state` = 2
        </if>
        LIMIT #{offset}, 10;
    </select>

    <select id="selectTotalReservations" resultType="int">
        SELECT COUNT(a.`acc_name`) FROM
            `lemo_product_accommodation` AS a LEFT JOIN
            `lemo_product_reservation`   AS b ON a.`acc_id` = b.`acc_id` LEFT JOIN
            `lemo_product_room`          AS c ON b.`room_id` = c.`room_id`
        WHERE b.`user_id` = #{user_id}
    </select>

    <select id="selectMemberCoupons" resultType="kr.co.Lemo.domain.CouponVO">
        SELECT
            a.`cp_id`, a.`cp_subject`, a.`cp_rate`, a.`cp_price`, a.`cp_start`, a.`cp_end`, a.`cp_minimum`, a.`cp_disType`, b.`user_id`, b.`mcp_isUsed`
        FROM
            `lemo_product_coupon` AS a LEFT JOIN
            `lemo_member_coupon` AS b ON a.`cp_id` = b.`cp_id`
        WHERE ( a.`cp_end` > DATE(NOW()) AND b.`mcp_end` > DATE(NOW()) )
        AND b.`user_id`=#{user_id} AND a.`cp_IssuedCnt` != 0;
    </select>

    <select id="selectProductCoupons" resultType="kr.co.Lemo.domain.CouponVO">
        SELECT * FROM `lemo_product_coupon`
        WHERE `cp_id` NOT IN( SELECT `cp_id` FROM `lemo_member_coupon` WHERE `user_id` = #{user_id} )
        AND `cp_end` > DATE(NOW())
        AND `cp_IssuedCnt` != 0;
    </select>

    <select id="selectProductCouponCnt" resultType="int">
        SELECT `cp_IssuedCnt` FROM `lemo_product_coupon` WHERE `cp_id` = #{cp_id};
    </select>

    <select id="selectPicks" resultType="kr.co.Lemo.domain.ProductAccommodationVO">
        SELECT
            b.`acc_id`, b.`acc_name`, b.`province_no`, b.`acc_addr`, b.`acc_addrDetail`, b.`acc_rate`, b.`acc_thumbs`, b.`acc_review`
        FROM
            `lemo_product_pick` AS a LEFT JOIN
            `lemo_product_accommodation` AS b ON a.`acc_id` = b.`acc_id`
        WHERE a.`user_id` = #{user_id}
        LIMIT #{offset}, 10;
    </select>

    <select id="selectTotalPicks" resultType="int">
        SELECT COUNT(b.`acc_id`) FROM
            `lemo_product_pick` AS a LEFT JOIN
            `lemo_product_accommodation` AS b ON a.`acc_id` = b.`acc_id`
        WHERE a.`user_id` = #{user_id};
    </select>

    <select id="selectReviews" resultType="kr.co.Lemo.domain.ReviewVO">
        SELECT
            a.`province_no`, a.`acc_name`, a.`acc_id`, a.`acc_thumbs`, b.`res_checkIn`, b.`res_checkOut`
        FROM
            `lemo_product_accommodation` AS a LEFT JOIN
            `lemo_product_reservation` AS b ON a.`acc_id` = b.`acc_id` LEFT JOIN
            `lemo_product_review` AS c ON b.`res_no` = c.`res_no`
        WHERE c.`user_id` = #{user_id};
    </select>

    <select id="selectDiaryArticle" resultType="kr.co.Lemo.domain.ArticleDiaryVO">
        SELECT * FROM `lemo_diary_article` WHERE `user_id`=#{user_id};
    </select>

    <select id="selectDiarySpot" resultType="kr.co.Lemo.domain.DiarySpotVO">
        SELECT * FROM `lemo_diary_spot` WHERE `arti_no`=#{arti_no};
    </select>

    <select id="selectDiary" resultType="kr.co.Lemo.domain.DiarySpotVO">
        SELECT
            a.`arti_title`, b.*
        FROM
            `lemo_diary_article` AS a JOIN
            `lemo_diary_spot` AS b ON a.`arti_no` = b.`arti_no`
        WHERE `user_id`=#{user_id};
    </select>

    <select id="selectProvinceAddr" resultType="kr.co.Lemo.domain.ProductAccommodationVO">
        SELECT
            c.`province_name`, b.`acc_addr`
        FROM
            `lemo_product_reservation` AS a LEFT JOIN
            `lemo_product_accommodation`  AS b ON a.`acc_id` = b.`acc_id` LEFT JOIN
            `lemo_product_province` AS c ON b.`province_no` = c.`province_no`
        WHERE a.`res_no` = #{res_no};
    </select>

    <!-- insert -->
    <insert id="insertDiaryArticle" parameterType="kr.co.Lemo.domain.ArticleDiaryVO" useGeneratedKeys="true" keyProperty="arti_no">
        INSERT INTO `lemo_diary_article` SET
            `res_no`     = #{res_no},
            `user_id`    = #{user_id},
            `arti_title` = #{arti_title},
            `arti_thumb` = #{arti_thumb},
            `arti_rdate` = NOW(),
            `arti_regip` = #{arti_regip},
            `arti_start` = #{arti_start},
            `arti_end`   = #{arti_end}
    </insert>

    <insert id="insertDiarySpot" parameterType="kr.co.Lemo.domain.DiarySpotVO">
        INSERT INTO `lemo_diary_spot` SET
            `arti_no`         = #{arti_no},
            `spot_longtitude` = #{spot_longtitude},
            `spot_lattitude`  = #{spot_lattitude},
            `spot_xy`         = ST_GeomFromText(CONCAT('POINT(', #{spot_longtitude}, ' ', #{spot_lattitude}, ')')),
            `spot_title`      = #{spot_title},
            `spot_content`    = #{spot_content},
            `spot_thumb`      = #{spot_thumb},
            `province_name`   = #{province_name},
            `spot_addr`       = #{spot_addr}
    </insert>

    <insert id="insertCoupon" parameterType="kr.co.Lemo.domain.CouponVO">
        INSERT INTO `lemo_member_coupon` (`cp_id`, `user_id`, `mcp_start`, `mcp_end`, `mcp_rdate`)
        SELECT #{cp_id}, #{user_id}, NOW(), DATE_ADD(NOW(), INTERVAL `cp_daysAvailable` DAY), NOW()
        FROM `lemo_product_coupon` WHERE `cp_id` = #{cp_id};
    </insert>

    <!-- update -->
    <update id="updateProfile">
        UPDATE `lemo_member_userinfo` SET
            `photo`=#{photo},
            `rdate`=NOW()
        WHERE `user_id`=#{username};
    </update>

    <update id="updateProductCoupon">
        UPDATE `lemo_product_coupon` SET
            `cp_IssuedCnt` = ( `cp_IssuedCnt` - 1 )
        WHERE `cp_id` = #{cp_id}
    </update>

    <!-- delete -->


    <!-- 공통 키 -->

</mapper>