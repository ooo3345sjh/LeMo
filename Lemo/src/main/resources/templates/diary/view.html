<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layouts/default-layout">
<th:block layout:fragment="css-js">
    <!-- 스타일 -->
    <link rel="stylesheet" th:href="@{/css/diary/diary.css}">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
</th:block>
<th:block layout:fragment="content">
    <main id="diary">
        <div id="result">
            <div class="content">
                <!-- 여행일기 보기 -->
                <div class="view">
                    <div class="list-area">
                        <div id="diary_content">
                            <span>[[${article.get(0).getArti_title}]]</span>
                            <ul>
                                <li>[[${article.get(0).getArti_start}]] ~ [[${article.get(0).getArti_end}]]</li>
                                <li>스카이베이호텔 경포</li>
                                <li>홍길동&nbsp;&nbsp;[[${article.get(0).getArti_rdate.substring(0,10)}]]</li>
                                <li>[[${article.get(0).getArti_like}]]</li>
                            </ul>
                        </div>
                        <!-- 여행장소 -->
                        <div class="place" th:each="spot:${article}">
                            <div class="spot">
                                <span>[[${spot.spot_title}]]</span>
                            </div>
                            <img th:src="@{/images/cs/arr_down.png}" class="arrow">
                            <div class="toggle">
                                <div class="image">
                                    <img th:src="@{/img/diary/__${spot.arti_no}__/__${spot.spot_thumb}__}">
                                </div>
                                <div class="text">[[${spot.spot_content}]]</div>
                            </div>
                        </div>
                        <!-- 여행일기 댓글 -->
                        <div class="reply">
                            <div id="tit">
                                <span>댓글</span><b>[[${total}]]</b>개
                            </div>
                            <div id="rep">
                                <div class="commentEmpty" th:if="${map.size == 0}">
                                    등록된 댓글이 없습니다.
                                </div>
                                <ul th:if="${map.size != 0}">
                                    <!--댓글-->
                                    <th:block th:each="com:${map}">
                                        <li th:each="comment:${map.get(com.key)}" th:classappend="${comment.com_no != comment.com_pno} ? 're_reply'">
                                            <div class="repdiv1">
                                                <img th:src="@{/images/admin/user_default.png}" alt="프사">
                                                <div>
                                                    <strong>[[${comment.nick}]]</strong><span>[[${comment.com_rdate.substring(0,10)}]]</span>
                                                </div>
                                            </div>
                                            <div class="repdiv2"><textarea readonly>[[${comment.com_comment}]]</textarea></div>
                                            <div class="repdiv3">
                                                <div>
                                                    <a href="#" class="showall">댓글 모두보기</a>
                                                    <a href="#" class="comment">댓글 쓰기</a>
                                                </div>
                                                <div>
                                                    <a href="#">수정</a>
                                                    <a href="#">삭제</a>
                                                </div>
                                            </div>
                                        </li>
                                    </th:block>
                                    <!-- 답댓글 쓰기-->
                                    <div class="write_reply re">
                                        <form action="#">
                                            <textarea></textarea>
                                            <button>댓글 쓰기</button>
                                        </form>
                                    </div>
                                </ul>
                            </div>
                        </div>
                        <!-- 댓글 쓰기 -->
                        <div class="write_reply">
                            <form action="#">
                                <textarea></textarea>
                                <button>댓글 쓰기</button>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- 지도 -->
                <div id="listMap">
                    <p>
                        <button onclick="setZoomable(false)">지도 확대/축소 끄기</button>
                        <button onclick="setZoomable(true)">지도 확대/축소 켜기</button>
                    </p>
                </div>
            </div>
        </div>
    </main>

</th:block>

<th:block layout:fragment="script">
    <!-- kakaoMap -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5685a7d59ed7c0a5f62806eae3f98712&libraries=services"></script>
    <script th:inline="javascript">
        let positionMap = [[${article}]];
        let overlays = new Map();

        /** 카카오 맵 */
        var container = document.getElementById('listMap'); //지도를 담을 영역의 DOM 레퍼런스
        var options = { //지도를 생성할 때 필요한 기본 옵션
            center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
            level: 5 //지도의 레벨(확대, 축소 정도)
        };

        var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
        map.setZoomable(false);
        function setZoomable(zoomable) {
            // 마우스 휠로 지도 확대,축소 가능여부를 설정합니다
            map.setZoomable(zoomable);
        }

        var bounds = new kakao.maps.LatLngBounds();

        function closeOverlay(spot_no) {
            let overlay = overlays.get(spot_no);
            overlay.setMap(null);
        }

        var imageSrc = '/Lemo/images/index/lemo_logo-removebg-preview.png', // 마커이미지의 주소입니다
        imageSize = new kakao.maps.Size(40, 60), // 마커이미지의 크기입니다
        imageOption = {offset: new kakao.maps.Point(21, 59)}; // 마커이미지의 옵션입니다. 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정합니다.

        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

        positionMap.forEach(function(position, i){

            var marker = new kakao.maps.Marker({
                image : markerImage,
                position : new kakao.maps.LatLng(position.spot_lattitude, position.spot_longtitude)
            });

            marker.setMap(map);

            bounds.extend(marker.getPosition());

            let content = '<div class="spot_wrap">';
               content += '<div class="spot_title">';
               content += position.spot_title
               content += '<div class="spot_close" title="닫기" onclick="closeOverlay('+position.spot_no+')"></div>'
               content += '</div>';
               content += '<div class="spot_content">';
               content += position.arti_title
               content += '</div>';
               content += '</div>';

            var overlay = new kakao.maps.CustomOverlay({
                content: content,
                position: marker.getPosition()
            });

            overlays.set(position.spot_no, overlay);

            kakao.maps.event.addListener(marker, 'click', function() {
                overlays.forEach(function(over){ over.setMap(null); });

                overlay.setMap(map);
            });

        });

        map.setBounds(bounds);

        $(function(){

            /** 카카오맵 - 스크롤 따라 이동 */
            $(window).scroll(function() {

                let currentPosition = parseInt($('#listMap').css('top'));
                let mapHeight = $('#listMap').height();
                let listHeight = $('.list-area').height();
                let boxOffsetTop = $('.list-area').offset().top;

                let scrollTop = $(window).scrollTop();
                let point;
                let endPoint = listHeight - mapHeight;


                if( scrollTop < boxOffsetTop ){
                    point = 0;
                }else if( scrollTop > endPoint ) {
                    point = endPoint-30;
                }else {
                    point = (scrollTop - boxOffsetTop)+100;
                }

                if(point < 0) {point = 0}

                $('#listMap').stop().animate({top: point}, 700);
            });


            /* 글 토글 */
            $('.place').click(function(e){
                e.preventDefault();
                $(this).find('.toggle').slideToggle();
                $(this).find('.toggle').prev().toggleClass('on');
            });

            /* 답 댓글쓰기 */
            $('.comment').click(function(e){
                e.preventDefault();

                let status = $('.write_reply.re').hasClass('show');
                if(!status){
                    $('.write_reply.re').addClass('show');
                }else {
                    $('.write_reply.re').removeClass('show');
                }
            });

            /* 댓글 모두 보기 */
            $('.showall').click(function(e){
                e.preventDefault();

                let status = $(this).hasClass('open');

                if(status) {
                    $(this).text('댓글 모두보기');
                    $(this).removeClass('open');
                    $(this).parent().parent().find('.re_reply').removeClass('open');
                }else {
                    $(this).text('댓글 숨기기');
                    $(this).addClass('open');
                    $(this).parent().parent().find('.re_reply').addClass('open'); // 답댓글 보기
                }
            });
        });
    </script>
</th:block>
</html>

